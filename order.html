<h1 data-i18n="order">Sargyt</h1>
<div id="gameBox" class="summary" data-i18n="selected_none">Saýlanan oýun ýok.</div>

<form id="orderForm" onsubmit="sendOrder(event)">
  <div class="row">
    <div>
      <label data-i18n="your_name">Adyňyz</label>
      <input id="name" required />
    </div>
    <div>
      <label data-i18n="phone">Telefon / WhatsApp</label>
      <input id="phone" required />
    </div>
  </div>

  <div class="row">
    <div>
      <label data-i18n="qty">Mukdary</label>
      <input id="qty" type="number" min="1" value="1" required />
    </div>
    <div>
      <label data-i18n="pay">Töleg görnüşi</label>
      <select id="pay">
        <option data-i18n="cash">Nağd</option>
        <option data-i18n="card">Kart</option>
      </select>
    </div>
  </div>

  <label data-i18n="note">Bellik (islege görä)</label>
  <textarea id="note" rows="3"></textarea>

  <div class="actions">
    <button class="btn primary" type="submit" data-i18n="order">Sargyt</button>
    <a class="btn" href="index.html" data-i18n="back">← Yza</a>
  </div>
</form>

<script>
  const LS_LANG='siteLang';
  let dict={}, lang = localStorage.getItem(LS_LANG) || 'en';

  async function loadI18n(){
    dict = await fetch('lang.json').then(r=>r.json());
    setLang(lang);
    hydrateGame();
  }
  function setLang(l){
    lang=l; localStorage.setItem(LS_LANG,l);
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k=el.getAttribute('data-i18n');
      if(dict[l] && dict[l][k]) el.textContent=dict[l][k];
    });
  }

  function hydrateGame(){
    const box=document.getElementById('gameBox');
    const sel=JSON.parse(localStorage.getItem('selectedGame')||'null');
    if(!sel) return;
    const unit = sel.discount ? Math.round(sel.price*(100-sel.discount)/100) : sel.price;
    box.innerHTML = `<strong>${sel.name}</strong>
      ${sel.platform?`<span class="pill" style="margin-left:.4rem">${sel.platform}</span>`:''}
      ${sel.discount?`<span class="pill" style="margin-left:.4rem">-${sel.discount}%</span>`:''}
      <div style="margin-top:.4rem"><span data-i18n="price_each">${dict[lang].price_each}</span>: <b>${unit} TMT</b></div>`;
    window.unitPrice = unit;
  }

  function sendOrder(e){
    e.preventDefault();
    const sel=JSON.parse(localStorage.getItem('selectedGame')||'null');
    const name=document.getElementById('name').value.trim();
    const phone=document.getElementById('phone').value.trim();
    const qty=parseInt(document.getElementById('qty').value||'1',10);
    const pay=document.getElementById('pay').value;
    const note=document.getElementById('note').value.trim();
    const total=(window.unitPrice||0)*qty;

    const subject=encodeURIComponent(`${dict[lang].order}: ${sel?sel.name:'Game'} x${qty}`);
    const body=encodeURIComponent(
      `Game: ${sel?sel.name:'-'}\nPlatform: ${sel?.platform||'-'}\n`+
      `${dict[lang].price_each}: ${window.unitPrice||0} TMT\nQty: ${qty}\nTotal: ${total} TMT\n`+
      `Name: ${name}\nPhone: ${phone}\nPay: ${pay}\nNote: ${note}`
    );
    window.location.href=`mailto:contact@example.com?subject=${subject}&body=${body}`;
  }

  loadI18n();
</script>